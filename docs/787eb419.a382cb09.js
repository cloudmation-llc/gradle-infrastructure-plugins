(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{107:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return l})),n.d(t,"metadata",(function(){return c})),n.d(t,"rightToc",(function(){return p})),n.d(t,"default",(function(){return b}));var a=n(2),r=n(6),o=(n(0),n(114)),i=n(115),l={id:"cf-tutorial",title:"Tutorial",sidebar_label:"Tutorial"},c={id:"aws/cloudformation/cf-tutorial",title:"Tutorial",description:"So, you followed the steps in Getting Started, and an empty project is ready to go. Now what?",source:"@site/docs/aws/cloudformation/tutorial.md",permalink:"/gradle-infrastructure-plugins/aws/cloudformation/cf-tutorial",sidebar_label:"Tutorial",sidebar:"mainSidebar",previous:{title:"Getting Started",permalink:"/gradle-infrastructure-plugins/aws/cloudformation/cf-getting-started"},next:{title:"CloudFormation Configuration",permalink:"/gradle-infrastructure-plugins/aws/cloudformation/cf-config"}},p=[{value:"Step 1 - Create Coudformation Directory",id:"step-1---create-coudformation-directory",children:[]},{value:"Step 2 - Configure Global Defaults",id:"step-2---configure-global-defaults",children:[]},{value:"Step 3 - Create Network Directory",id:"step-3---create-network-directory",children:[]},{value:"Step 4 - Create vpc.yml Template",id:"step-4---create-vpcyml-template",children:[]},{value:"Step 5 - First Gradle Review",id:"step-5---first-gradle-review",children:[]},{value:"Step 6 - Create the VPC",id:"step-6---create-the-vpc",children:[]},{value:"Step 7 - Add First Availability Zone",id:"step-7---add-first-availability-zone",children:[]},{value:"Step 8 - Create Additional Availability Zones",id:"step-8---create-additional-availability-zones",children:[]},{value:"Conclusion",id:"conclusion",children:[]}],s={rightToc:p};function b(e){var t=e.components,n=Object(r.a)(e,["components"]);return Object(o.b)("wrapper",Object(a.a)({},s,n,{components:t,mdxType:"MDXLayout"}),Object(o.b)("p",null,"So, you followed the steps in ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"cf-getting-started"}),"Getting Started"),", and an empty project is ready to go. Now what?"),Object(o.b)("p",null,"The CloudFormation plugin works by looking for specific directories, iterating through the files within, and generating runnable tasks according to what it finds. To demonstrate how this works, we will create a small VPC composed of resources to enable three availability zones with both public and private networking in the ",Object(o.b)("inlineCode",{parentName:"p"},"us-west-2")," region."),Object(o.b)("p",null,"As you proceed through the steps, at times you will see a reference to the ",Object(o.b)("em",{parentName:"p"},"project root"),". This refers to the directory that contains your entire project, or for absence of doubt where ",Object(o.b)("inlineCode",{parentName:"p"},"settings.gradle")," lives."),Object(o.b)("h3",{id:"step-1---create-coudformation-directory"},"Step 1 - Create Coudformation Directory"),Object(o.b)("p",null,"Create a ",Object(o.b)("inlineCode",{parentName:"p"},"cloudformation")," directory. This will serve as the root folder for all templates. You can have as many subdirectories as you want to organize your templates. Each subdirectory where at least one template is found is made into a Gradle subproject."),Object(o.b)("h3",{id:"step-2---configure-global-defaults"},"Step 2 - Configure Global Defaults"),Object(o.b)("p",null,"In the project root, open ",Object(o.b)("inlineCode",{parentName:"p"},"build.gradle"),". You will just see 3 lines which import the project plugin."),Object(o.b)("p",null,"If you want to set a specific region and credentials profile, add a ",Object(o.b)("inlineCode",{parentName:"p"},"aws")," config block."),Object(o.b)("p",null,"If you do not set your own values, the region and credentials are resolved by the AWS SDK. The series of checks performed by the SDK is best described in the ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://sdk.amazonaws.com/java/api/latest/software/amazon/awssdk/awscore/client/builder/AwsClientBuilder.html#region-software.amazon.awssdk.regions.Region-"}),"javadocs"),"."),Object(o.b)("p",null,"If you do use a ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://sdk.amazonaws.com/java/api/latest/software/amazon/awssdk/auth/credentials/ProfileCredentialsProvider.html"}),"named profile"),", then the SDK works with your local ",Object(o.b)("inlineCode",{parentName:"p"},"$HOME/.aws/config")," and ",Object(o.b)("inlineCode",{parentName:"p"},"$HOME/.aws/credentials")," files."),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-groovy"}),'aws {\n    profile = "named_profile_goes_here"\n    region = "us-west-2"\n}\n')),Object(o.b)("h3",{id:"step-3---create-network-directory"},"Step 3 - Create Network Directory"),Object(o.b)("p",null,"Within the ",Object(o.b)("inlineCode",{parentName:"p"},"cloudformation")," directory, create another directory named ",Object(o.b)("inlineCode",{parentName:"p"},"network"),"."),Object(o.b)("h3",{id:"step-4---create-vpcyml-template"},"Step 4 - Create vpc.yml Template"),Object(o.b)("p",null,"Within the ",Object(o.b)("inlineCode",{parentName:"p"},"network")," directory, created a template file named ",Object(o.b)("inlineCode",{parentName:"p"},"vpc.yml"),"."),Object(o.b)("div",{className:"admonition admonition-info alert alert--info"},Object(o.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-heading"}),Object(o.b)("h5",{parentName:"div"},Object(o.b)("span",Object(a.a)({parentName:"h5"},{className:"admonition-icon"}),Object(o.b)("svg",Object(a.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(o.b)("path",Object(a.a)({parentName:"svg"},{fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"})))),"Tip")),Object(o.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-content"}),Object(o.b)("p",{parentName:"div"},"YAML is highly recommended over JSON for designing CloudFormation templates. ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://aws.amazon.com/blogs/mt/the-virtues-of-yaml-cloudformation-and-using-cloudformation-designer-to-convert-json-to-yaml"}),"The wins are too numerous to list here"),"."))),Object(o.b)("p",null,"Template samples are provided below for the benefit of the tutorial, but certainly feel free to substitute your own templates."),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-yaml",metastring:'title="Sample vpc.yml"',title:'"Sample','vpc.yml"':!0}),"Description: VPC master configuration\n\nResources:\n\n  #\n  # The VPC\n  #\n  Vpc:\n    Type: AWS::EC2::VPC\n    Properties:\n      CidrBlock: 10.255.0.0/16\n      EnableDnsSupport: true\n      EnableDnsHostnames: true\n\n  #\n  # DHCP options\n  #\n  DhcpOptions:\n    Type: AWS::EC2::DHCPOptions\n    Properties:\n      DomainName: us-west-2.compute.internal\n      DomainNameServers:\n        - AmazonProvidedDNS\n\n  DhcpOptionsAssociation:\n    Type: AWS::EC2::VPCDHCPOptionsAssociation\n    Properties: \n      DhcpOptionsId: !Ref DhcpOptions\n      VpcId: !Ref Vpc\n\n  #\n  # Assignable elastic IP for network egress\n  #\n  EipRoot:\n    DependsOn: Vpc\n    Type: AWS::EC2::EIP\n    Properties:\n      Domain: vpc\n\n  #\n  # Internet Gateway\n  #\n  InternetGateway:\n    Type: AWS::EC2::InternetGateway\n\n  InternetGatewayAttachment:\n    Type: AWS::EC2::VPCGatewayAttachment\n    Properties:\n      VpcId: !Ref Vpc\n      InternetGatewayId: !Ref InternetGateway\n\n#\n# Stack outputs\n#\nOutputs:\n  VpcId:\n    Description: The VPC ID\n    Value: !Ref Vpc\n    Export:\n      Name: VpcId\n\n  EipRootAllocationId:\n    Description: Allocation ID for the root elastic IP\n    Value: !GetAtt EipRoot.AllocationId\n    Export:\n      Name: VpcEipRootAllocationId\n\n  InternetGatewayId:\n    Description: Internet gateway ID for public subnets\n    Value: !Ref InternetGateway\n    Export:\n      Name: VpcInternetGateway\n")),Object(o.b)("h3",{id:"step-5---first-gradle-review"},"Step 5 - First Gradle Review"),Object(o.b)("div",{className:"admonition admonition-note alert alert--secondary"},Object(o.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-heading"}),Object(o.b)("h5",{parentName:"div"},Object(o.b)("span",Object(a.a)({parentName:"h5"},{className:"admonition-icon"}),Object(o.b)("svg",Object(a.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(o.b)("path",Object(a.a)({parentName:"svg"},{fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"})))),'"Gradle" vs "Gradlew"')),Object(o.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-content"}),Object(o.b)("p",{parentName:"div"},"If you are using the Gradle wrapper such as via the starter template, then all Gradle commands can be run by using the ",Object(o.b)("inlineCode",{parentName:"p"},"./gradlew")," or ",Object(o.b)("inlineCode",{parentName:"p"},".\\gradlew.bat")," scripts."))),Object(o.b)("p",null,"Once ",Object(o.b)("inlineCode",{parentName:"p"},"vpc.yml")," is created and has some content, this is a good point to check out what the Gradle plugins will do. From the project root run ",Object(o.b)("inlineCode",{parentName:"p"},"gradle projects"),"."),Object(o.b)("img",{alt:"Screenshot of Gradle projects",src:Object(i.a)("/img/screenshots/aws-tutorial-p1-gradle-projects.png"),style:{width:"80%"}}),Object(o.b)("p",null,"Note now that ",Object(o.b)("inlineCode",{parentName:"p"},"vpc.yml")," is detected, its containing directory ",Object(o.b)("inlineCode",{parentName:"p"},"network")," becomes a subproject. As a convenience, the plugin also generated an empty Gradle build file with the same name. You should see ",Object(o.b)("inlineCode",{parentName:"p"},"network.gradle")," with the template."),Object(o.b)("p",null,"Now, let's look at the tasks. Run ",Object(o.b)("inlineCode",{parentName:"p"},"gradle tasks"),"."),Object(o.b)("img",{alt:"Screenshot of Gradle tasks",src:Object(i.a)("/img/screenshots/aws-tutorial-p1-gradle-tasks.png"),style:{width:"80%"}}),Object(o.b)("p",null,"The plugin automatically creates a ",Object(o.b)("inlineCode",{parentName:"p"},"lintVpc")," task using the filename to run the ",Object(o.b)("inlineCode",{parentName:"p"},"cfn-lint")," tool to check for template errors and overall correctness. A ",Object(o.b)("inlineCode",{parentName:"p"},"deployVpc")," task is also created which will do the actual work of creating the CloudFormation stack and changeset. The deploy task has the linting task set as a dependency so that every deploy will first lint the template to check for errors."),Object(o.b)("h3",{id:"step-6---create-the-vpc"},"Step 6 - Create the VPC"),Object(o.b)("p",null,"Run the ",Object(o.b)("inlineCode",{parentName:"p"},"deployVpc")," task, and watch the VPC stack with its resources get created. After the build completes successfully, you will be able to browse around the AWS console and see the everything that was created."),Object(o.b)("h3",{id:"step-7---add-first-availability-zone"},"Step 7 - Add First Availability Zone"),Object(o.b)("p",null,"For simplicity, we will create the network resources for each availability zone in separate template files. There other more advanced methods to take advantage of template reuse and parameters discussed later in the documentation."),Object(o.b)("p",null,"Create a file named ",Object(o.b)("inlineCode",{parentName:"p"},"vpc-zone-a.yml")," in the same directory as ",Object(o.b)("inlineCode",{parentName:"p"},"vpc.yml"),", and copy and paste the content below into it."),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-yaml",metastring:"Sample vpc-zone-a.yml",Sample:!0,"vpc-zone-a.yml":!0}),'Description: VPC availability zone A\n\nParameters:\n  PrivateRange:\n    Type: String\n    AllowedPattern: "([1-9]|[1-9]\\\\d|1\\\\d{2}|2[0-4]\\\\d|25[0-5])(\\\\.(\\\\d|[1-9]\\\\d|1\\\\d{2}|2[0-4]\\\\d|25[0-5])){3}\\\\/\\\\d+"\n    Default: 10.255.1.0/24\n  \n  PublicRange:\n    Type: String\n    AllowedPattern: "([1-9]|[1-9]\\\\d|1\\\\d{2}|2[0-4]\\\\d|25[0-5])(\\\\.(\\\\d|[1-9]\\\\d|1\\\\d{2}|2[0-4]\\\\d|25[0-5])){3}\\\\/\\\\d+"\n    Default: 10.255.251.0/24\n\n  RegionAzIndex:\n    Type: Number\n    Default: 0\n\nResources:\n\n  #\n  # Private subnet\n  #\n  SubnetPrivate:\n    Type: AWS::EC2::Subnet\n    Properties:\n      AvailabilityZone: !Select \n        - !Ref RegionAzIndex\n        - Fn::GetAZs: !Ref "AWS::Region"\n      CidrBlock: !Ref PrivateRange\n      Tags:\n        - Key: Type\n          Value: private\n      VpcId: !ImportValue VpcId\n\n  #\n  # Public subnet\n  #\n  SubnetPublic:\n    Type: AWS::EC2::Subnet\n    Properties:\n      AvailabilityZone: !Select \n        - !Ref RegionAzIndex\n        - Fn::GetAZs: !Ref "AWS::Region"\n      CidrBlock: !Ref PublicRange\n      Tags:\n        - Key: Type\n          Value: public\n      VpcId: !ImportValue VpcId\n      \n  #\n  # Route table for public subnet\n  #\n  RouteTablePublic:\n    Type: AWS::EC2::RouteTable\n    Properties:\n      VpcId: !ImportValue VpcId\n\n  RouteTablePublicSubnetAssociation:\n    Type: AWS::EC2::SubnetRouteTableAssociation\n    Properties:\n      SubnetId: !Ref SubnetPublic\n      RouteTableId: !Ref RouteTablePublic\n\n  RoutePublicRouteInternetGateway:\n    Type: AWS::EC2::Route\n    Properties:\n      RouteTableId: !Ref RouteTablePublic\n      DestinationCidrBlock: 0.0.0.0/0\n      GatewayId: !ImportValue VpcInternetGateway\n')),Object(o.b)("p",null,"Run ",Object(o.b)("inlineCode",{parentName:"p"},"gradle tasks")," again, and you will see new tasks created to lint and deploy the zone A template."),Object(o.b)("p",null,"Now run ",Object(o.b)("inlineCode",{parentName:"p"},"gradle deployVpcZoneA")," to create the resources."),Object(o.b)("h3",{id:"step-8---create-additional-availability-zones"},"Step 8 - Create Additional Availability Zones"),Object(o.b)("p",null,"Copy ",Object(o.b)("inlineCode",{parentName:"p"},"vpc-zone-a.yml")," to new files ",Object(o.b)("inlineCode",{parentName:"p"},"vpc-zone-b.yml")," and ",Object(o.b)("inlineCode",{parentName:"p"},"vpc-zone-c.yml"),". Open each of the new zone files, and adjust the default values for the parameters accordingly so that the IP ranges are unique, and the correct availability zone identifier is set."),Object(o.b)("p",null,Object(o.b)("strong",{parentName:"p"},"Suggested Parameter Values:")),Object(o.b)("table",null,Object(o.b)("thead",{parentName:"table"},Object(o.b)("tr",{parentName:"thead"},Object(o.b)("th",Object(a.a)({parentName:"tr"},{align:null}),"File"),Object(o.b)("th",Object(a.a)({parentName:"tr"},{align:null}),"PrivateRange"),Object(o.b)("th",Object(a.a)({parentName:"tr"},{align:null}),"PublicRange"),Object(o.b)("th",Object(a.a)({parentName:"tr"},{align:null}),"RegionAzIndex"))),Object(o.b)("tbody",{parentName:"table"},Object(o.b)("tr",{parentName:"tbody"},Object(o.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"vpc-zone-a.yml"),Object(o.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(o.b)("inlineCode",{parentName:"td"},"10.255.1.0/24")),Object(o.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(o.b)("inlineCode",{parentName:"td"},"10.255.251.0/24")),Object(o.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(o.b)("inlineCode",{parentName:"td"},"0"))),Object(o.b)("tr",{parentName:"tbody"},Object(o.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"vpc-zone-b.yml"),Object(o.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(o.b)("inlineCode",{parentName:"td"},"10.255.2.0/24")),Object(o.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(o.b)("inlineCode",{parentName:"td"},"10.255.252.0/24")),Object(o.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(o.b)("inlineCode",{parentName:"td"},"1"))),Object(o.b)("tr",{parentName:"tbody"},Object(o.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"vpc-zone-c.yml"),Object(o.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(o.b)("inlineCode",{parentName:"td"},"10.255.3.0/24")),Object(o.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(o.b)("inlineCode",{parentName:"td"},"10.255.253.0/24")),Object(o.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(o.b)("inlineCode",{parentName:"td"},"2"))))),Object(o.b)("p",null,"Once the templates have been adjusted, you can run multiple tasks in series and deploy resources for several stacks in one shot. Deploy zone B and zone C together by running ",Object(o.b)("inlineCode",{parentName:"p"},"gradle deployVpcZoneB deployVpcZoneC"),"."),Object(o.b)("h3",{id:"conclusion"},"Conclusion"),Object(o.b)("p",null,"Tutorial complete! At this, you now have an overview of how the Gradle plugins can help you set up an organized AWS project. Without any deep customization, the plugin applied simple conventions to your templates to create standard operaring procedures for making the deployment, and providing sensible defaults along the way such as how stacks get named."),Object(o.b)("p",null,"Throughout the rest of this documentation, we will lift the hood on more advanced configuration so that you can tweak the conventions to suit your specific needs."))}b.isMDXComponent=!0},113:function(e,t,n){"use strict";var a=n(0),r=n(33);t.a=function(){return Object(a.useContext)(r.a)}},114:function(e,t,n){"use strict";n.d(t,"a",(function(){return b})),n.d(t,"b",(function(){return m}));var a=n(0),r=n.n(a);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var p=r.a.createContext({}),s=function(e){var t=r.a.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},b=function(e){var t=s(e.components);return r.a.createElement(p.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},u=r.a.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,i=e.parentName,p=c(e,["components","mdxType","originalType","parentName"]),b=s(n),u=a,m=b["".concat(i,".").concat(u)]||b[u]||d[u]||o;return n?r.a.createElement(m,l(l({ref:t},p),{},{components:n})):r.a.createElement(m,l({ref:t},p))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,i=new Array(o);i[0]=u;var l={};for(var c in t)hasOwnProperty.call(t,c)&&(l[c]=t[c]);l.originalType=e,l.mdxType="string"==typeof e?e:a,i[1]=l;for(var p=2;p<o;p++)i[p]=n[p];return r.a.createElement.apply(null,i)}return r.a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},115:function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var a=n(113);function r(e){const{siteConfig:t}=Object(a.a)(),{baseUrl:n="/"}=t||{};if(!e)return e;return/^(https?:|\/\/)/.test(e)?e:e.startsWith("/")?n+e.slice(1):n+e}}}]);